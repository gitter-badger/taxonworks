<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name=viewport
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>HTML5 draw and drag</title>

    <script src="http://code.jquery.com/jquery-1.11.3.min.js">// js/jquery-1.7.min.js"</script>
    <script src="modernizr.custom.34982.js"></script>

    <script src="sketcher.js"></script>
    <!--<script src="js/trigonometry.js"></script>-->

    <link rel="stylesheet" href="assets/bootstrap.css"/>
    <link rel="stylesheet" href="assets/styles.css"/>

    <script>
        var sketcher = null;
        var xC = 0;
        var yC = 0;
        var cursorMode = "MOVE";
        var cursorColor = '#ff0000'
        var zoom = 0.2;         /////////////////////////////
        var canvas;
        var context;
        var svgImage = new Image();
        var instanceImage;
        var svg = [];           // collect the collections here
        var thisSvg = [];            // collect points as [x,y]
        //canvas_image.src = undefined;
//        svgImage.src = "../../../../spec/support/images/frost_stage.jpg";
        svgImage.src = 'frost_stage.jpg';
        $(document).ready(function (e) {
            sketcher = new Sketcher("sketch");
            indicateMode();
//    canvas = document.getElementById("sketch");
//    context = canvas.getContext("2d");
//    setMove();
//    renderImage();
        });

        $(svgImage).load(function () {
            xC = 0;
            yC = 0;
            zoom = document.getElementById('svgLayer').width.baseVal.value / svgImage.width;     // in general more complicated than this
       // insert the svg base image into the transformable group <g id='xlt'>
            var xlt = document.getElementById('xlt');
            var xltImage = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            xltImage.setAttributeNS(null, 'id', "xltImage");
            xltImage.setAttributeNS(null, 'x', "0");
            xltImage.setAttributeNS(null, 'y', "0");
            xltImage.setAttributeNS(null, 'width', svgImage.width.toString());
            xltImage.setAttributeNS(null, 'height', svgImage.height.toString());
            xltImage.setAttributeNS(null, 'preserveAspectRatio', "none");
            xltImage.setAttributeNS('http://www.w3.org/1999/xlink','href', svgImage.src);
            xlt.appendChild(xltImage);

            canvas = document.getElementById("sketch");     // set up the dynamic draw layer
            context = canvas.getContext("2d");
            setMove();
        });

        function clearCanvas() {
            sketcher.clear();
            xC = 0;
            yC = 0;
            renderImage();
        }
        function setDraw() {
            cursorMode = "PATH";
            indicateMode();
        }

        function setMove() {
            cursorMode = "MOVE";
            indicateMode();
        }

        function indicateMode() {
            document.getElementById("mode").textContent = cursorMode;
            $("#zoom").html("Zoom:" + zoom.toFixed(3));
        }

        function clearGroup() {
            var xlt=document.getElementById("xlt");
            xlt.lastChild.remove();
        }

        function setCursorMode(mode) {
            cursorMode = mode;
            indicateMode();
        }

        function zoomIn() {
            zoom = zoom * 1.25;
            $("#zoom").html("Zoom:" + zoom.toFixed(3));
            zoom_trans(null, null, zoom);
            setMove();
//            renderImage();
        }
        function zoomOut() {
            if (zoom > 0) {
                zoom = zoom * 0.8;
                $("#zoom").html("Zoom:" + zoom.toFixed(3));
                zoom_trans(null, null, zoom);
                setMove();
//                renderImage();
            }
        }

        function zoom_trans(x, y, factor) {
            if (x == null) {x = 0}
            if (y == null) {y = 0}
//            xC = 0.5 * (xC - x);
//            yC = 0.5 * (yC - y);
            var xlt = document.getElementById('xlt');         // DOM svg element g xlt
            var transform = xlt.attributes['transform'].value;          // string of transform="translate( x, y )scale(n.m)"
//            var trans_scale = transform.split('scale');
            transform = 'translate(' + ((xC)).toString() + ', ' + ((yC)).toString() + ')scale(' + factor.toString() + ')';
//            transform = 'translate(' + ((xC - x) / zoom).toString() + ', ' + ((yC - y) / zoom).toString() + ')scale(' + factor.toString() + ')';
//            transform = 'translate(' + (xC / zoom).toString() + ', ' + (yC / zoom).toString() + ')scale(' + factor.toString() + ')';
            xlt.attributes['transform'].value = transform;
            $("#zoom").html("Zoom:" + zoom.toFixed(3));
        }

        function renderImage() {
            if (xC >= canvas_image.width - canvas.width) {
                xC = canvas_image.width - canvas.width;
            }
//    xC, yC is -left, -top boundary of canvas, [also source point of canvas_image - no longer used]
//    want to window the canvas_image into the canvas isometrically
//    and proportional to zoom level

//            if ((xC - canvas_image.width) * zoom >= canvas.width) {   // clip on xC
//                xC = (canvas_image.width - canvas.width) * zoom;
//            }
            if (yC >= canvas_image.height - canvas.height) {
                yC = canvas_image.height - canvas.height;
            }
            if (xC < 0) {
                xC = 0;
            }
            if (yC < 0) {
                yC = 0;
            }
//            context.fillOpacity = "0.0";
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        // TODO:
        // bounds check on move (in sketcher.js)
        // aspect ratio compensation source to target canvas
        // capture svg data - DONE
        // source image from http://
    </script>
    <style type='text/css'>
        #container {
            overflow: hidden;
            width: 800px;
            height: 600px;
        }
    </style>

</head>

<body>
<div class="topbar-wrapper" style="z-index: 5;">
    <div class="topbar" data-dropdown="dropdown">
        <div class="topbar-inner">
            <div class="container">
                <h3><a href="#">Image annotation using HTML5 drag and draw on canvas overlaying svg</a></h3>

                <ul class="nav">
                    <li class="active">Annotate image using sketcher app using "lineTo(x,y)" drawing and moveTo(x,y), dragging<br>
                        and scroll zoom implemented.  Text, Circle, Polygon, Line to follow.
                    </li>
                </ul>

                <ul class="nav secondary-nav">
                    <input type="button" class="btn error" value="clear" onclick="clearGroup();"/>
                    <input type="button" class="btn error" value="Polygon" onclick="setCursorMode('POLY');"/>
                    <input type="button" class="btn error" value="Line" onclick="setCursorMode('LINE');"/>
                    <input type="button" class="btn error" value="Circle" onclick="setCursorMode('CIRCLE');"/>
                    <input type="button" class="btn error" value="Path" onclick="setCursorMode('PATH');"/>
                    <span id="mode"></span>
                    <input type="button" value="Move" onclick="setMove();"/>
                    <input type="button" value="Text" onclick="setCursorMode('TEXT');"/>
                    <input type="button" value="Zoom IN" onclick="zoomIn();"/>
                    <span id="zoom">Zoom: ---</span>
                    <input type="button" value="Zoom OUT" onclick="zoomOut();"/>
                </ul>
            </div>
        </div>
        <!-- /topbar-inner -->
    </div>
    <!-- /topbar -->
</div>
<div id="container" style="overflow: hidden">
    <svg id="svgLayer" width="800" height="600" xmlns="http://www.w3.org/2000/svg" version="1.1"
         style="left: 50px; top: 150px; position: absolute;" >
        <g id="xlt" transform="translate(0,0)scale(0.20)">
            <!--<image id="xltImage" x="0" y="0" width="4000" height="3000" preserveAspectRatio="none" xlink:href="frost_stage.jpg" ></image>-->
            <!--<image id="xltImage" x="0" y="0" width="0" height="0" preserveAspectRatio="none"></image>-->
            <circle id='cursor' cx='250' cy='180' r='20' fill='#ff0000' fill-opacity='0.5'/>
        </g>
    </svg>
    <canvas id="sketch" width="800" height="600" style="left: 50px; top: 150px; position: absolute; opacity: 0.8">
    </canvas>

</div>
</body>
</html>
