<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name=viewport
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>HTML5 draw and drag</title>

    <script src="http://code.jquery.com/jquery-1.11.3.min.js">// js/jquery-1.7.min.js"</script>
    <script src="modernizr.custom.34982.js"></script>

    <script src="sketcher.js"></script>
    <!--<script src="js/trigonometry.js"></script>-->

    <link rel="stylesheet" href="assets/bootstrap.css"/>
    <link rel="stylesheet" href="assets/styles.css"/>

    <script>
        var sketcher = null;
        var xC;
        var yC;
        var cursorMode;
        var drawMode = "PATH";
        var zoom = 0;
        var canvas;
        var context;
        var canvas_image = new Image();
        var svg = [];           // collect the collections here
        var thisSvg = [];            // collect points as [x,y]
        //canvas_image.src = undefined;
        canvas_image.src = "../../../../spec/support/images/frost_stage.jpg";
        //          SVG_files\javascripts\assets\app\ to "root" then /spec...
        //canvas_image.src = "file:///Users/jrflood/src/taxonworks/spec/support/images/frost_stage.jpg";
        //canvas_image.src = 'frost_stage.jpg';
        $(document).ready(function (e) {
            sketcher = new Sketcher("sketch");
//    canvas = document.getElementById("sketch");
//    context = canvas.getContext("2d");
//    setMove();
//    renderImage();
        });

        $(canvas_image).load(function () {
            xC = 0;
            yC = 0;
            zoom = 0;
            canvas = document.getElementById("sketch");
            context = canvas.getContext("2d");
            setMove();
            renderImage();
        });

        function clearCanvas() {
            sketcher.clear();
            xC = 0;
            yC = 0;
            renderImage();
        }
        function setDraw() {
            cursorMode = "DRAW";
            indicateMode();
        }

        function setMove() {
            cursorMode = "MOVE";
            indicateMode();
        }

        function indicateMode() {
            document.getElementById("mode").textContent = cursorMode;
        }

        function setPolygon() {drawMode = "POLYGON"}

        function setLine() {drawMode = "LINE"}

        function setCircle() {drawMode = "CIRCLE"}

        function setPath() {drawMode = "PATH"}

        function zoomIn() {
            zoom = zoom + 1;
            var factor = Math.pow(2, zoom);
            $("#zoom").html("Zoom:" + zoom);
            zoom_trans(null, null, factor);
            setMove();
//            renderImage();
        }
        function zoomOut() {
            if (zoom > 0) {
                zoom = zoom - 1;
                var factor = Math.pow(2, zoom);
                $("#zoom").html("Zoom:" + zoom);
                zoom_trans(null, null, factor);
                setMove();
//                renderImage();
            }
        }

        function zoom_trans(x, y, factor) {
            var xlt = document.getElementById('xlt');         // DOM svg element g xlt
            var transform = xlt.attributes['transform'].value;          // string of transform="translate( x, y )scale(n.m)"
            var trans_scale = transform.split('scale');
            var translate =
            transform = 'translate(' + xC.toString() + ', ' + yC.toString() + ')scale(' + factor.toString() + ')';
            xlt.attributes['transform'].value = transform;
        }

        function renderImage() {
            if (xC >= canvas_image.width - canvas.width) {
                xC = canvas_image.width - canvas.width;
            }
//    xC, yC is -left, -top boundary of canvas, [also source point of canvas_image - no longer used]
//    want to window the canvas_image into the canvas isometrically
//    and proportional to zoom level

//            if ((xC - canvas_image.width) * zoom >= canvas.width) {   // clip on xC
//                xC = (canvas_image.width - canvas.width) * zoom;
//            }
            if (yC >= canvas_image.height - canvas.height) {
                yC = canvas_image.height - canvas.height;
            }
            if (xC < 0) {
                xC = 0;
            }
            if (yC < 0) {
                yC = 0;
            }
//            context.fillOpacity = "0.0";
           context.clearRect(0, 0, canvas.width, canvas.height);
//            context.drawImage(canvas_image, 0, 0, canvas_image.width / Math.pow(2, zoom), canvas_image.height / Math.pow(2, zoom),
//                    0, 0, canvas.width, canvas.height);
// ***           context.drawImage(canvas_image, xC, yC, canvas_image.width / Math.pow(2, zoom), canvas_image.height / Math.pow(2, zoom),
// ***                  0, 0, canvas.width, canvas.height);
//            context.drawImage(canvas_image, xC, yC, canvas_image.width, canvas_image.height, 0, 0, canvas.width, canvas.height);
//            context.drawImage(canvas_image, xC, yC);
//            context.drawImage(canvas_image, 0, 0);
             var element;
//  ***            svgLayer.innerHTML = '';
     //   image x="0" y="0" width="400" height="357" preserveAspectRatio="none" href="/images/3/scale_to_box/0/640/2640/2360/400/400
//            element = document.createElementNS('http://www.w3.org/2000/svg', 'image');
//            svgLayer.appendChild(element);
//            element.setAttributeNS(null, 'x', '0');
//            element.setAttributeNS(null, 'y', '0');
//            element.setAttributeNS(null, 'width', '800');       // svgLayer.width);
//            element.setAttributeNS(null, 'height', '600');      // svgLayer.height);
//            element.setAttributeNS(null, 'preserveAspectRatio', 'none');
////            element.setAttributeNS(null, 'href', '/images/3/scale_to_box/0/640/2640/2360/800/600');
//            element.setAttributeNS(null, 'xlink:href', '/frost_stage.jpg');

//            for (i = 0; i < svg.length; i++) {
//                thisSvg = svg[i];
//      // only add new elements
//                for (j = 0; j < thisSvg.length; j++) {
//
//                    element = document.createElementNS('http://www.w3.org/2000/svg', 'line');
//                    element.setAttributeNS(null, 'stroke', 'red');
//                    element.setAttributeNS(null, 'stroke-width', '3');
//                    element.setAttributeNS(null, 'stroke-opacity', '0.5');
//                    svgLayer.appendChild(element);
//                    element.setAttributeNS(null, 'x1', thisSvg[j][0]);      // start x
//                    element.setAttributeNS(null, 'y1', thisSvg[j][1]);      // start y
//                    j += 1;
//                    element.setAttributeNS(null, 'x2', thisSvg[j][0]);      // end x
//                    element.setAttributeNS(null, 'y2', thisSvg[j][1]);      // end y
//                }
//            }
        }

        // TODO:
        // bounds check on move (in sketcher.js)
        // aspect ratio compensation source to target canvas
        // capture svg data
        // source image from http://
    </script>
    <style type='text/css'>
        #container {
            overflow: hidden;
            width: 800px;
            height: 600px;
        }
    </style>

</head>

<body>
<div class="topbar-wrapper" style="z-index: 5;">
    <div class="topbar" data-dropdown="dropdown">
        <div class="topbar-inner">
            <div class="container">
                <h3><a href="#">HTML5 drag and draw on canvas</a></h3>

                <ul class="nav">
                    <li class="active"><a href="#">sketch app using "lineTo(x,y)" drawing and moveTo(x,y) dragging</a>
                    </li>
                </ul>

                <ul class="nav secondary-nav">
                    <input type="button" class="btn error" value="clear" onclick="clearCanvas();"/>
                    <input type="button" class="btn error" value="Polygon" onclick="setPolygon();"/>
                    <input type="button" class="btn error" value="Line" onclick="setLine();"/>
                    <input type="button" class="btn error" value="Circle" onclick="setCircle();"/>
                    <input type="button" class="btn error" value="Path" onclick="setPath();"/>
                    <input type="button" value="Draw" onclick="setDraw();"/>
                    <span id="mode"></span>
                    <input type="button" value="Move" onclick="setMove();"/>
                    <input type="button" value="Zoom IN" onclick="zoomIn();"/>
                    <span id="zoom">Zoom: 0</span>
                    <input type="button" value="Zoom OUT" onclick="zoomOut();"/>
                    <!--<input type="hidden" id="zoom" value="0" />-->
                    <!--<input type="hidden" id="xC" value="0" />-->
                    <!--<input type="button" value="Down" onclick="panDown();" />-->
                    <!--<input type="button" value="Up" onclick="panUp();" />-->
                    <!--<input type="button" value="Left" onclick="panLeft();" />-->
                    <!--<input type="button" value="Right" onclick="panRight();" />-->
                    <!--<input type="hidden" id="yC" value="0" />-->
                </ul>
            </div>
        </div>
        <!-- /topbar-inner -->
    </div>
    <!-- /topbar -->
</div>
<div id="container" style="overflow: hidden">
    <svg id="svgLayer" width="800" height="600" xmlns="http://www.w3.org/2000/svg" version="1.1"
             style="left: 50px; top: 125px; position: absolute;" currentScale="1.0" viewBox="0 0 800 600">
        <g id="xlt" transform="translate(0,0)scale(1.0)">
            <image x="0" y="0" width="800" height="600" preserveAspectRatio="none" xlink:href="frost_stage.jpg" ></image>
            <circle id='cursor' cx='250' cy='180' r='20' fill='#ff0000' fill-opacity='0.5'/>
        </g>
        </svg>
    <canvas id="sketch" width="800" height="600" style="left: 50px; top: 125px; position: absolute; opacity: 0.8">
    </canvas>

</div>
</body>
</html>
