<!doctype html>
< lang="en">
<head>
    <meta charset="utf-8">
    <title>Movable and Re-sizable Raphael JS Shape</title>
</head>

<div id="paper"></div>
<input type="button" id="getBox" value="Hit ME" onclick="getBox();">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<!--<script src="http://github.com/DmitryBaranovskiy/raphael/raw/master/raphael-min.js"></script>-->
<script src="file:///Users/jrflood/src/taxonworks/app/assets/javascripts/Raphael.js"></script>

<script>
    function getBox() {
    //  alert(boxX + ' | ' + boxY + ' | ' + boxW + ' | ' + boxH);
        canvas = document.getElementById("selected_picture_canvas");
        context = canvas.getContext('2d');
        imageObject = new Image();
        imageObject.src = 'file:///Users/jrflood/src/taxonworks/spec/support/images/frost_stage.jpg';
        var destWidth;
        var destHeight;
        var ratio = 4000.0 / 700.0
        var sourceX = boxX * ratio;
        var sourceY = boxY * ratio;
        var sourceWidth = boxW * ratio;
        var sourceHeight = boxH * ratio;
        if (boxW >= boxH) {
            destWidth = canvas.width;
            destHeight = canvas.height * (boxH / boxW);
        }
        else {
            destHeight = canvas.height;
            destWidth = canvas.width * (boxW / boxH);
        }
//        destWidth = canvas.width;          // was sourceWidth;
//        destHeight = canvas.height;         // was sourceHeight;
        var destX = 0;          // was canvas.width / 2 - destWidth / 2;
        var destY = 0;          // was canvas.height / 2 - destHeight / 2;
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.drawImage(imageObject, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);

    }
    ;

    var boxX;
    var boxY;
    var boxW;
    var boxH;
    var imageObject;
    var canvas;
    var context;


    var set_select_box = function () {

        var dragStart = function () {

            // Save some starting values
            this.ox = this.attr('x');
            this.oy = this.attr('y');
            this.ow = this.attr('width');
            this.oh = this.attr('height');
//            boxX = this.ox;
//            boxY = this.oy;
//            boxW = this.ow;
//            boxH = this.oh;

            this.dragging = true;
        };


        var dragMove = function (dx, dy) {

            // Inspect cursor to determine which resize/move process to use
            switch (this.attr('cursor')) {

                case 'nw-resize' :
                    this.attr({
                        x: this.ox + dx,
                        y: this.oy + dy,
                        width: this.ow - dx,
                        height: this.oh - dy
                    });
                    break;

                case 'ne-resize' :
                    this.attr({
                        y: this.oy + dy,
                        width: this.ow + dx,
                        height: this.oh - dy
                    });
                    break;

                case 'se-resize' :
                    this.attr({
                        width: this.ow + dx,
                        height: this.oh + dy
                    });
                    break;

                case 'sw-resize' :
                    this.attr({
                        x: this.ox + dx,
                        width: this.ow - dx,
                        height: this.oh + dy
                    });
                    break;

                default :
                    this.attr({
                        x: this.ox + dx,
                        y: this.oy + dy
                    });
                    break;

            }
            boxX = this.attr("x");
            boxY = this.attr("y");
            boxW = this.attr("width");
            boxH = this.attr("height");
        };

        var dragEnd = function () {
            this.dragging = false;
        };

        var changeCursor = function (e, mouseX, mouseY) {

            // Don't change cursor during a drag operation
            if (this.dragging === true) {
                return;
            }

            // X,Y Coordinates relative to shape's orgin
            var relativeX = mouseX - $('#paper').offset().left - this.attr('x');
            var relativeY = mouseY - $('#paper').offset().top - this.attr('y');

            var shapeWidth = this.attr('width');
            var shapeHeight = this.attr('height');

            var resizeBorder = 10;

            // Change cursor
            if (relativeX < resizeBorder && relativeY < resizeBorder) {
                this.attr('cursor', 'nw-resize');
            } else if (relativeX > shapeWidth - resizeBorder && relativeY < resizeBorder) {
                this.attr('cursor', 'ne-resize');
            } else if (relativeX > shapeWidth - resizeBorder && relativeY > shapeHeight - resizeBorder) {
                this.attr('cursor', 'se-resize');
            } else if (relativeX < resizeBorder && relativeY > shapeHeight - resizeBorder) {
                this.attr('cursor', 'sw-resize');
            } else {
                this.attr('cursor', 'move');
            }
        };


        // Create drawing area
        var paper = Raphael("paper", 700, 700);
        paper.image("file:///Users/jrflood/src/taxonworks/spec/support/images/frost_stage.jpg", 0, 0, 700, 525);
        // Add a rectangle
        var shapes = paper.add([{
            'type': 'rect',
            'x': 150,
            'y': 150,
            'width': 100,
            'height': 100,
            'fill': '#ffffff',
            'stroke': '#000000',
            'stroke-width': 1,
            'opacity': 0.4
        }]);
        boxX = shapes[0].node.attributes.x.value;
        boxY = shapes[0].node.attributes.y.value;
        boxW = shapes[0].node.attributes.width.value;
        boxH = shapes[0].node.attributes.height.value;
// Attach "Mouse Over" handler to rectangle
        shapes[0].mousemove(changeCursor);

        // Attach "Drag" handlers to rectangle
        shapes[0].drag(dragMove, dragStart, dragEnd);

    };
    $(document).ready(set_select_box());

</script>
<div id="selected_picture">
    <canvas id="selected_picture_canvas" height="400" width="400"></canvas>
</div>
</body>
</html>